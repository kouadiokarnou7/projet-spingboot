<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
</head>

<body class="bg-slate-50 min-h-screen font-sans">

<!-- NAVBAR -->
<nav class="bg-white sticky top-0 shadow-sm border-b px-8 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-slate-800">
        Espace <span class="text-blue-600">Admin</span>
    </h1>
    <form th:action="@{/logout}" method="post">
        <button class="text-red-600 font-bold">Déconnexion</button>
    </form>
</nav>

<main class="max-w-5xl mx-auto mt-10 px-6">

    <!-- HEADER -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-black text-slate-900">Gestion des effectifs</h2>
        <button onclick="toggleModal('modal-ajout')"
                class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold">
            <i class="fa fa-plus"></i> Nouvel Employé
        </button>
    </div>

    <!-- SEARCH -->
    <input id="search-input"
           type="text"
           placeholder="Rechercher par nom ou matricule..."
           class="w-full mb-6 p-3 rounded-xl border"/>

    <!-- TABLE -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <table class="w-full">
            <thead class="bg-slate-100">
            <tr>
                <th class="p-4 text-left">Matricule</th>
                <th class="p-4 text-left">Nom</th>
                <th class="p-4 text-right">Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Chargement initial via Thymeleaf -->
            <tr th:each="emp : ${employes}">
                <td class="p-4" th:text="${emp.matricule}"></td>
                <td class="p-4" th:text="${emp.nom}"></td>
                <td class="p-4 text-right">
                    <button th:onclick="'editEmploye(' + ${emp.id} + ')'"
                            class="text-blue-600 mr-2">
                        <i class="fa fa-pen"></i>
                    </button>
                    <button th:onclick="'deleteEmploye(' + ${emp.id} + ')'"
                            class="text-red-600">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<!-- MODAL -->
<div id="modal-ajout" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl w-full max-w-md">
        <h3 class="text-xl font-bold mb-4">Nouvel Employé</h3>
        <form id="form_employe" class="space-y-4">
            <input name="matricule" placeholder="Matricule" class="w-full p-2 border rounded" required>
            <input name="nom" placeholder="Nom" class="w-full p-2 border rounded" required>
            <button class="w-full bg-blue-600 text-white py-2 rounded">Enregistrer</button>
        </form>
    </div>
</div>

<!-- SCRIPT -->
<script>
function toggleModal(id) {
    document.getElementById(id).classList.toggle("hidden");
}

/* ===== RENDER TABLE ===== */
function renderEmployes(employes) {
    const tbody = document.querySelector("tbody");
    tbody.innerHTML = "";

    employes.forEach(emp => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="p-4">${emp.matricule}</td>
            <td class="p-4">${emp.nom}</td>
            <td class="p-4 text-right">
                <button onclick="editEmploye(${emp.id})" class="text-blue-600 mr-2">
                    <i class="fa fa-pen"></i>
                </button>
                <button onclick="deleteEmploye(${emp.id})" class="text-red-600">
                    <i class="fa fa-trash"></i>
                </button>
            </td>`;
        tbody.appendChild(row);
    });
}

/* ===== CREATE ===== */
document.getElementById("form_employe").addEventListener("submit", e => {
    e.preventDefault();

    fetch("/api/employes/create", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            matricule: e.target.matricule.value,
            nom: e.target.nom.value
        })
    })
    .then(() => fetch("/api/employes"))
    .then(r => r.json())
    .then(data => {
        renderEmployes(data);
        toggleModal("modal-ajout");
        e.target.reset();
    });
});

/* ===== DELETE ===== */
function deleteEmploye(id) {
    if (!confirm("Supprimer cet employé ?")) return;

    fetch(`/api/employes/${id}`, {method: "DELETE"})
        .then(() => fetch("/api/employes"))
        .then(r => r.json())
        .then(renderEmployes);
}

/* ===== UPDATE ===== */
function editEmploye(id) {
    //on repelle pas le formulaire de création, on utilise des prompts pour simplifier
    
    const nom = prompt("Nouveau nom ?");
    const matricule = prompt("Nouveau matricule ?");

    if (!nom || !matricule) return;

    fetch(`/api/employes/${id}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({nom, matricule: parseInt(matricule)})
    })
    .then(() => fetch("/api/employes"))
    .then(r => r.json())
    .then(renderEmployes);
}

/* ===== SEARCH ===== */
document.getElementById("search-input").addEventListener("input", e => {
    const q = e.target.value.toLowerCase();

    fetch("/api/employes")
        .then(r => r.json())
        .then(data => {
            const filtered = data.filter(emp =>
                emp.nom.toLowerCase().includes(q) ||
                String(emp.matricule).includes(q)
            );
            renderEmployes(filtered);
        });
});
</script>

</body>
</html>
