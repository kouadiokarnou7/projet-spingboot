<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>Gestion des effectifs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
</head>

<body class="bg-slate-50 min-h-screen font-sans" 
      th:with="isAuthenticated=${#authentication != null and #authentication.authenticated}">

<div id="toast-container" class="fixed top-5 right-5 z-[100] flex flex-col gap-2"></div>

<!-- PAGE DE CONNEXION -->
<div th:unless="${isAuthenticated}" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Evo<span class="text-blue-600">Corp</span></h1>
            <p class="text-gray-500 mt-2">Connectez-vous à votre espace</p>
        </div>
        <form th:action="@{/login}" method="post" class="space-y-6">
            <div th:if="${param.error}" class="bg-red-50 text-red-600 p-3 rounded-lg text-sm">
                Identifiants incorrects
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                <input type="text" name="username" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                <input type="password" name="password" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button type="submit" 
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                Se connecter
            </button>
        </form>
        <div class="mt-6 text-center text-sm text-gray-500">
            <p>Admin: admin / admin123</p>
            <p>Employé: jdupont / pass123</p>
        </div>
    </div>
</div>

<!-- PAGE PRINCIPALE -->
<div th:if="${isAuthenticated}">
    <nav class="bg-white sticky top-0 shadow-sm border-b px-8 py-4 flex justify-between items-center z-40">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-slate-800">
                EvoCorp - <span class="text-blue-600" th:text="${#authentication.name}"></span>
                <span th:if="${#authorization.expression('hasRole(''ADMIN'')')}" 
                      class="ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">Admin</span>
                <span th:unless="${#authorization.expression('hasRole(''ADMIN'')')}" 
                      class="ml-2 text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full">Employé</span>
            </h1>
        </div>
        <form th:action="@{/logout}" method="post">
            <button class="text-red-600 font-bold hover:text-red-800 transition">
                <i class="fa fa-sign-out-alt mr-2"></i>Déconnexion
            </button>
        </form>
    </nav>

    <main class="max-w-6xl mx-auto mt-10 px-6 pb-10">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-black text-slate-900">Gestion des effectifs</h2>
            <div class="space-x-4" sec:authorize="hasRole('ADMIN')">
                <button onclick="toggleModal('modal-departement')"
                        class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition">
                    <i class="fa fa-building"></i> Nouveau Département
                </button>
                <button onclick="toggleModal('modal-employe')"
                        class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                    <i class="fa fa-plus"></i> Nouvel Employé
                </button>
            </div>
        </div>

        <div class="mb-6">
            <input id="search-input"
                   type="text"
                   placeholder="Rechercher par nom, prénom ou matricule..."
                   class="w-full p-4 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
        </div>

        <div class="bg-white rounded-xl shadow overflow-hidden">
            <table class="w-full">
                <thead class="bg-slate-100">
                    <tr>
                        <th class="p-4 text-left font-semibold text-gray-700">Matricule</th>
                        <th class="p-4 text-left font-semibold text-gray-700">Nom</th>
                        <th class="p-4 text-left font-semibold text-gray-700">Prénom</th>
                        <th class="p-4 text-left font-semibold text-gray-700">Fonction</th>
                        <th class="p-4 text-left font-semibold text-gray-700">Département</th>
                        <th class="p-4 text-right font-semibold text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody id="employes-tbody">
                    <tr>
                        <td colspan="6" class="p-8 text-center text-gray-400">
                            <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Chargement...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div sec:authorize="hasRole('ADMIN')" class="mt-10">
            <h3 class="text-xl font-bold mb-4 text-slate-800">Départements</h3>
            <div class="bg-white rounded-xl shadow p-6">
                <div id="departements-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-gray-400 text-center col-span-full">
                        <i class="fa fa-spinner fa-spin"></i> Chargement...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-departement" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Nouveau Département</h3>
            <form id="form-departement" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom du département *</label>
                    <input type="text" id="departement-nom" name="nom" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition">
                </div>
                <div class="flex space-x-3 pt-2">
                    <button type="submit" 
                            class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                        <i class="fa fa-check mr-2"></i>Créer
                    </button>
                    <button type="button" onclick="toggleModal('modal-departement')"
                            class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                        <i class="fa fa-times mr-2"></i>Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-employe" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Nouvel Employé</h3>
            <form id="form-employe" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Matricule *</label>
                    <input type="text" id="employe-matricule" name="matricule" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                    <input type="text" id="employe-nom" name="nom" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prénom *</label>
                    <input type="text" id="employe-prenom" name="prenom" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fonction *</label>
                    <select id="employe-fonction" name="fonction" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <option value="">Sélectionnez une fonction</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Département *</label>
                    <select id="employe-departement" name="departementId" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <option value="">Sélectionnez un département</option>
                    </select>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" 
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                        <i class="fa fa-save mr-2"></i>Enregistrer
                    </button>
                    <button type="button" onclick="toggleModal('modal-employe')"
                            class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                        <i class="fa fa-times mr-2"></i>Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-edit-employe" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Modifier Employé</h3>
            <form id="form-edit-employe" class="space-y-4">
                <input type="hidden" id="edit-employe-id" name="id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Matricule *</label>
                    <input type="text" id="edit-employe-matricule" name="matricule" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                    <input type="text" id="edit-employe-nom" name="nom" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prénom *</label>
                    <input type="text" id="edit-employe-prenom" name="prenom" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fonction *</label>
                    <select id="edit-employe-fonction" name="fonction" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <option value="">Sélectionnez une fonction</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Département *</label>
                    <select id="edit-employe-departement" name="departementId" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <option value="">Sélectionnez un département</option>
                    </select>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" 
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                        <i class="fa fa-check mr-2"></i>Mettre à jour
                    </button>
                    <button type="button" onclick="toggleModal('modal-edit-employe')"
                            class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                        <i class="fa fa-times mr-2"></i>Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ===== CONFIGURATION GLOBALE =====
const CONFIG = {
    API: {
        employes: '/api/employes',
        employesCreate: '/api/employes/create',
        employeById: (id) => `/api/employes/${id}`,
        departements: '/api/departements'
    },
    fonctionsEntreprise: [
        "Développeur",
        "Chef de projet",
        "Designer UX/UI",
        "Administrateur système",
        "Comptable",
        "RH",
        "Responsable marketing",
        "Technicien",
        "Directeur",
        "Assistant administratif"
    ]
};

// ===== GESTION DU CACHE =====
const CACHE = {
    employes: [],
    departements: [],
    initialized: false
};

// ===== FONCTIONS UTILITAIRES =====

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    const bgClass = type === 'success' ? 'bg-green-600' : 'bg-red-600';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform transition-all duration-300 translate-x-full opacity-0`;
    toast.innerHTML = `<i class="fa ${icon} text-lg"></i><span class="font-medium">${message}</span>`;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.remove('translate-x-full', 'opacity-0'));
    setTimeout(() => {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

function clearErrors(formElement) {
    if (!formElement) return;
    formElement.querySelectorAll('.text-red-500.text-xs.mt-1').forEach(el => el.remove());
    formElement.querySelectorAll('input, select').forEach(input => {
        input.classList.remove('border-red-500', 'focus:ring-red-500');
        input.classList.add('border-gray-300');
    });
}

function showFieldError(fieldName, message, formElement) {
    if (!formElement) return;
    const input = formElement.querySelector(`[name="${fieldName}"]`) || formElement.querySelector(`#${fieldName}`);
    if (!input) return;
    input.classList.remove('border-gray-300');
    input.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'text-red-500 text-xs mt-1 font-semibold';
    errorDiv.innerHTML = `<i class="fa fa-exclamation-circle mr-1"></i>${message}`;
    input.parentNode.insertBefore(errorDiv, input.nextSibling);
}

async function handleApiResponse(response, successMsg = null) {
    const contentType = response.headers.get("content-type");
    if (response.ok) {
        if (successMsg) showToast(successMsg, 'success');
        if (contentType?.includes("application/json")) {
            return await response.json().catch(() => ({}));
        }
        return {};
    } else {
        let errorData = { message: `Erreur ${response.status}` };
        try {
            if (contentType?.includes("application/json")) {
                errorData = await response.json();
            } else {
                errorData.message = (await response.text()).substring(0, 150);
            }
        } catch {}
        showToast(errorData.message, 'error');
        if (errorData.errors || (typeof errorData === 'object' && !errorData.message)) {
            return { fieldErrors: errorData.errors || errorData, hasFieldErrors: true };
        }
        throw new Error(errorData.message);
    }
}

// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// CORRECTION : Fonction manquante AJOUTÉE
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
async function loadDepartmentsIntoSelects() {
    if (!CACHE.initialized) await loadAllData();
    const selects = [
        document.getElementById('employe-departement'),
        document.getElementById('edit-employe-departement')
    ];
    selects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Sélectionnez un département</option>';
            if (CACHE.departements.length === 0) {
                select.innerHTML += '<option value="" disabled>Aucun département</option>';
            } else {
                CACHE.departements.forEach(d => {
                    select.innerHTML += `<option value="${d.id}">${d.nom}</option>`;
                });
            }
        }
    });
}
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

function toggleModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    const isClosing = !modal.classList.contains('hidden');
    modal.classList.toggle("hidden");
    if (!isClosing) {
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
            clearErrors(form);
            if (modalId === 'modal-employe' || modalId === 'modal-edit-employe') {
                populateFonctionsSelects();
                loadDepartmentsIntoSelects();
            }
        }
    }
}

// ===== CHARGEMENT OPTIMISÉ =====
async function loadAllData() {
    try {
        const [employesRes, departementsRes] = await Promise.allSettled([
            fetch(CONFIG.API.employes).then(r => r.json()),
            fetch(CONFIG.API.departements).then(r => r.json())
        ]);

        CACHE.employes = employesRes.status === 'fulfilled' ? employesRes.value : [];
        CACHE.departements = departementsRes.status === 'fulfilled' ? departementsRes.value : [];

        renderEmployes(CACHE.employes);
        renderDepartements(CACHE.departements);
        CACHE.initialized = true;

    } catch (error) {
        console.error('Erreur initialisation:', error);
        showToast('Erreur de chargement des données', 'error');
    }
}

// ===== RENDU =====
function renderEmployes(employes) {
    const tbody = document.getElementById('employes-tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (!employes || employes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400"><i class="fa fa-users text-3xl mb-2"></i><p>Aucun employé trouvé</p></td></tr>';
        return;
    }

    // Détection du rôle admin (côté serveur via Thymeleaf)
    const isAdmin = /*[[${#authorization.expression('hasRole(''ADMIN'')')}]]*/ false;

    employes.forEach(emp => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-slate-50 transition-colors';

        let actionsHtml = '';
        if (isAdmin) {
            actionsHtml = `
                <button onclick="openEditModal(${emp.id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="Modifier">
                    <i class="fa fa-pen"></i>
                </button>
                <button onclick="deleteEmploye(${emp.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-full transition" title="Supprimer">
                    <i class="fa fa-trash"></i>
                </button>
            `;
        } else {
            actionsHtml = '<span class="text-gray-400 text-xs italic"><i class="fa fa-lock mr-1"></i>Lecture seule</span>';
        }

        row.innerHTML = `
            <td class="p-4 font-mono text-sm text-gray-600">${emp.matricule || 'N/A'}</td>
            <td class="p-4 font-medium text-gray-900">${emp.nom || ''}</td>
            <td class="p-4 text-gray-600">${emp.prenom || ''}</td>
            <td class="p-4 text-gray-600">${emp.fonction || ''}</td>
            <td class="p-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <i class="fa fa-building mr-1.5"></i>${emp.departement?.nom || 'Non affecté'}
                </span>
            </td>
            <td class="p-4 text-right">
                <div class="flex items-center justify-end space-x-2">
                    ${actionsHtml}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderDepartements(departements) {
    const container = document.getElementById('departements-list');
    if (!container) return;
    container.innerHTML = '';
    if (!departements || departements.length === 0) {
        container.innerHTML = '<p class="text-gray-400 col-span-full text-center"><i class="fa fa-building text-2xl mb-2"></i><br>Aucun département.</p>';
        return;
    }
    departements.forEach(dept => {
        const card = document.createElement('div');
        card.className = 'bg-gradient-to-br from-white to-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all';
        card.innerHTML = `<div class="font-bold text-gray-800 text-lg">${dept.nom}</div>`;
        container.appendChild(card);
    });
}

// ===== FONCTIONS PRÉDÉFINIES =====
function populateFonctionsSelects() {
    const selects = [
        document.getElementById('employe-fonction'),
        document.getElementById('edit-employe-fonction')
    ];
    selects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Sélectionnez une fonction</option>';
            CONFIG.fonctionsEntreprise.forEach(f => {
                select.innerHTML += `<option value="${f}">${f}</option>`;
            });
        }
    });
}

// ===== CRUD OPERATIONS =====
document.getElementById('form-departement')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    clearErrors(form);
    const departementData = { nom: document.getElementById('departement-nom').value.trim(), entreprise: { id: 1 } };
    try {
        const response = await fetch(CONFIG.API.departements, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(departementData)
        });
        const result = await handleApiResponse(response, 'Département créé avec succès ✓');
        if (!result.hasFieldErrors) {
            toggleModal('modal-departement');
            await loadAllData(); // Rafraîchir tout
        } else {
            Object.entries(result.fieldErrors).forEach(([field, msg]) => showFieldError(field, Array.isArray(msg) ? msg[0] : msg, form));
        }
    } catch {}
});

document.getElementById('form-employe')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    clearErrors(form);
    const deptId = document.getElementById('employe-departement').value;
    if (!deptId) {
        showFieldError('employe-departement', 'Sélectionnez un département', form);
        return;
    }
    const employeData = {
        matricule: document.getElementById('employe-matricule').value.trim(),
        nom: document.getElementById('employe-nom').value.trim(),
        prenom: document.getElementById('employe-prenom').value.trim(),
        fonction: document.getElementById('employe-fonction').value,
        departement: { id: parseInt(deptId) },
        entreprise: { id: 1 }
    };
    try {
        const response = await fetch(CONFIG.API.employesCreate, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(employeData)
        });
        const result = await handleApiResponse(response, 'Employé ajouté avec succès ✓');
        if (!result.hasFieldErrors) {
            toggleModal('modal-employe');
            await loadAllData(); // Rafraîchir tout
        } else {
            Object.entries(result.fieldErrors).forEach(([field, msg]) => showFieldError(field, Array.isArray(msg) ? msg.join(', ') : msg, form));
        }
    } catch {}
});

async function openEditModal(id) {
    try {
        const response = await fetch(CONFIG.API.employeById(id));
        if (!response.ok) throw new Error("Employé introuvable");
        const emp = await response.json();
        document.getElementById('edit-employe-id').value = emp.id;
        document.getElementById('edit-employe-matricule').value = emp.matricule || '';
        document.getElementById('edit-employe-nom').value = emp.nom || '';
        document.getElementById('edit-employe-prenom').value = emp.prenom || '';
        document.getElementById('edit-employe-fonction').value = emp.fonction || '';
        populateFonctionsSelects();
        await loadDepartmentsIntoSelects();
        if (emp.departement?.id) {
            document.getElementById('edit-employe-departement').value = emp.departement.id;
        }
        toggleModal('modal-edit-employe');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

document.getElementById('form-edit-employe')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    clearErrors(form);
    const id = document.getElementById('edit-employe-id').value;
    const deptId = document.getElementById('edit-employe-departement').value;
    if (!deptId) {
        showFieldError('edit-employe-departement', 'Sélectionnez un département', form);
        return;
    }
    const employeData = {
        id: parseInt(id),
        matricule: document.getElementById('edit-employe-matricule').value.trim(),
        nom: document.getElementById('edit-employe-nom').value.trim(),
        prenom: document.getElementById('edit-employe-prenom').value.trim(),
        fonction: document.getElementById('edit-employe-fonction').value,
        departement: { id: parseInt(deptId) }
    };
    try {
        const response = await fetch(CONFIG.API.employeById(id), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(employeData)
        });
        const result = await handleApiResponse(response, 'Employé mis à jour ✓');
        if (!result.hasFieldErrors) {
            toggleModal('modal-edit-employe');
            await loadAllData(); // Rafraîchir tout
        } else {
            Object.entries(result.fieldErrors).forEach(([field, msg]) => showFieldError(field, Array.isArray(msg) ? msg.join(', ') : msg, form));
        }
    } catch {}
});

async function deleteEmploye(id) {
    if (!confirm('⚠️ Êtes-vous sûr de vouloir supprimer cet employé ?')) return;
    try {
        const response = await fetch(CONFIG.API.employeById(id), { method: 'DELETE' });
        await handleApiResponse(response, 'Employé supprimé ✓');
        await loadAllData(); // Rafraîchir tout
    } catch {}
}

// ===== RECHERCHE =====
let searchTimeout;
document.getElementById('search-input')?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const keyword = e.target.value.toLowerCase().trim();
        const filtered = keyword === '' ? CACHE.employes :
            CACHE.employes.filter(emp => 
                emp.nom?.toLowerCase().includes(keyword) ||
                emp.prenom?.toLowerCase().includes(keyword) ||
                emp.matricule?.toLowerCase().includes(keyword) ||
                emp.fonction?.toLowerCase().includes(keyword)
            );
        renderEmployes(filtered);
    }, 200);
});

// ===== INITIALISATION =====
document.addEventListener('DOMContentLoaded', async () => {
    await loadAllData();
    populateFonctionsSelects();
});

window.addEventListener('error', (e) => console.error('Erreur globale:', e.error));
window.addEventListener('unhandledrejection', (e) => console.error('Promise rejetée:', e.reason));
</script>

</body>
</html>